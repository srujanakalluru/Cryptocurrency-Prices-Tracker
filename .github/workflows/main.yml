name: build and sonar
on:
  #push:
    #branches: ["feature-**"]
  pull_request:
    branches: ["main"]
    types: [ opened, synchronize, reopened ]
  workflow_dispatch:
  
permissions:
  pull-requests: read # allows SonarCloud to decorate PRs with analysis results

jobs:
  # maven build
  maven-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven
      - name: Build with Maven
        run: mvn clean package --file pom.xml
  # sonar analysis
  sonar-analysis:
    needs: maven-build
    runs-on: ubuntu-latest
    steps:
      - name: Cache SonarCloud packages
        uses: actions/cache@v1
        with:
         path: ~/.sonar/cache
         key: ${{ runner.os }}-sonar
         restore-keys: ${{ runner.os }}-sonar
      - name: Sonar Build and analyze
        env:
         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
         SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          # Additional arguments for the sonarcloud scanner
          args:
            # Unique keys of your project and organization. You can find them in SonarCloud > Information (bottom-left menu)
            # mandatory
            -Dsonar.projectKey=crypto-prices-tracker
            -Dsonar.organization=srujanakalluru
            -Dsonar.language=java
            -Dsonar.projectBaseDir=.
            -Dsonar.coverage.jacoco.xmlReportPaths=${sonar.projectBaseDir}target/site/jacoco/jacoco.xml
            -Dsonar.verbose=true
        uses: SonarSource/sonarcloud-github-action@de2e56b42aa84d0b1c5b622644ac17e505c9a049
  # docker compose up
  docker-build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v2
      - name: Log in to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: Build and push backend app
        uses: docker/build-push-action@v2
        with:
          context: .
          push: true
          tags: creationk/crypto-prices-tracker:latest
      - name: Start containers
        run: docker-compose up -d
  print-env-variables:
    runs-on: ubuntu-latest
    steps:
      - name: print env
        run: tree
        working-directory: .
